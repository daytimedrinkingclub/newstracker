{% extends "base.html" %}

{% block title %}Choose Your Plan{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-base font-semibold leading-6 text-gray-900">Choose your plan</h1>
        </div>
    </div>
    {% if current_plan %}
    <div class="mt-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4" role="alert">
        <p class="font-bold">Current Plan: {{ current_plan|capitalize }}</p>
        {% if current_plan == 'free' %}
            <p>Your free plan is active. It will remain active unless your API keys expire or you delete them.</p>
        {% elif current_plan == 'premium' %}
            <p>Your premium plan is active.</p>
        {% endif %}
    </div>
    {% endif %}
    <div class="mt-8 flow-root">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Freemium Plan -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="px-6 py-8">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Free</h3>
                    <p class="text-gray-600 mb-6">Use your own API keys for full functionality.</p>
                    <ul class="text-sm text-gray-600 mb-6">
                        <li class="mb-2">✓ Full access to features</li>
                        <li class="mb-2">✓ Add your own API keys</li>
                    </ul>
                    <div class="mb-4">
                        <input type="text" id="anthropicApiKey" placeholder="Anthropic API Key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm">
                    </div>
                    <div class="mb-4">
                        <input type="text" id="tavilyApiKey" placeholder="Tavily AI API Key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm">
                    </div>
                    <button onclick="submitFreemiumPlan()" class="w-full bg-black text-white rounded-md py-2 hover:bg-gray-800 transition duration-300">
                        {% if current_plan == 'free' %}Update Free Plan{% else %}Select Free Plan{% endif %}
                    </button>
                </div>
            </div>
            
            <!-- Paid Plan -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="px-6 py-8">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Premium</h3>
                    <p class="text-gray-600 mb-6">$12/month track 10 keywords</p>
                    <ul class="text-sm text-gray-600 mb-6">
                        <li class="mb-2">✓ Full access to features</li>
                        <li class="mb-2">✓ No need for API keys</li>
                    </ul>
                    {% if current_plan != 'premium' %}
                        <div id="paypal-button-container"></div>
                    {% else %}
                        <button disabled class="w-full bg-gray-300 text-gray-600 rounded-md py-2 cursor-not-allowed">Current Plan</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=AXkijMhO3DF_llgTfC8tOv15KsDC9irMsD3HgTMzBN-1jDl7k44vLItN7MasNanqwS73VrEx_FtaHXRA&currency=USD"></script>
<script>
    function submitFreemiumPlan() {
        const anthropicApiKey = document.getElementById('anthropicApiKey').value;
        const tavilyApiKey = document.getElementById('tavilyApiKey').value;
        
        fetch('/plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                plan: 'freemium', 
                anthropic_api_key: anthropicApiKey,
                tavily_api_key: tavilyApiKey
            }),
        })
        .then(response => response.json())
        .then(data => {
            alert('Free plan activated successfully!');
            location.reload();
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('Failed to activate Free plan. Please try again.');
        });
    }

    {% if current_plan != 'premium' %}
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '12.00'
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                fetch('/plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        plan: 'premium',
                        payment_details: details
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    alert('Premium plan activated successfully!');
                    location.reload();
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Failed to activate Premium plan. Please try again.');
                });
            });
        }
    }).render('#paypal-button-container');
    {% endif %}
</script>
{% endblock %}