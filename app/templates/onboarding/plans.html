{% extends "base.html" %}

{% block title %}Choose Your Plan{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-xl font-semibold leading-6 text-gray-900">Choose your plan, and Nishant you should choose premium</h1>
        </div>
    </div>
    {% if current_plan %}
    <div class="mt-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4" role="alert">
        <p class="font-bold">Current Plan: {{ current_plan|capitalize }}</p>
        {% if current_plan == 'free' %}
            <p>Your free plan is active. It will remain active unless your API keys expire or you delete them.</p>
        {% elif current_plan == 'premium' %}
            <p>Your premium plan is active.</p>
        {% endif %}
    </div>
    {% endif %}
    <div class="mt-8 flow-root">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Free Plan -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden flex flex-col h-full">
                <div class="px-6 py-8 flex-grow">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Free</h3>
                    <p class="text-gray-600 mb-6">Use your own API keys</p>
                    <div class="mb-4 relative">
                        <input type="text" id="anthropicApiKey" placeholder="Anthropic API Key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm p-2 pr-8">
                        <a href="https://docs.anthropic.com/en/docs/quickstart#prerequisites" target="_blank" class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                        </a>
                    </div>
                    <div class="mb-4 relative">
                        <input type="text" id="tavilyApiKey" placeholder="Tavily AI API Key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm p-2 pr-8">
                        <a href="https://tavily.com/#api" target="_blank" class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                        </a>
                    </div>
                </div>
                <div class="px-6 pb-8">
                    <button onclick="submitFreemiumPlan()" class="w-full bg-black text-white rounded-md py-3 hover:bg-gray-800 transition duration-300 text-lg">
                        {% if current_plan == 'free' %}Update Free Plan{% else %}Select Free Plan{% endif %}
                    </button>
                </div>
            </div>
            
        <!-- Premium Plan -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden flex flex-col h-full">
            <div class="px-6 py-8 flex-grow">
                <h3 class="text-2xl font-semibold text-gray-900 mb-4">Premium</h3>
                <p class="text-gray-600 mb-6">$12/month - track 10 keywords</p>
            </div>
            <div class="px-6 pb-8">
                {% if current_plan != 'premium' %}
                    <div id="paypal-button-container"></div>
                {% else %}
                    <button disabled class="w-full bg-gray-300 text-gray-600 rounded-md py-3 cursor-not-allowed text-lg">Current Plan</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=AXkijMhO3DF_llgTfC8tOv15KsDC9irMsD3HgTMzBN-1jDl7k44vLItN7MasNanqwS73VrEx_FtaHXRA&currency=USD"></script>
<script>
    function submitFreemiumPlan() {
        const anthropicApiKey = document.getElementById('anthropicApiKey').value;
        const tavilyApiKey = document.getElementById('tavilyApiKey').value;
        
        fetch('/plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                plan: 'freemium', 
                anthropic_api_key: anthropicApiKey,
                tavily_api_key: tavilyApiKey
            }),
        })
        .then(response => response.json())
        .then(data => {
            alert('Free plan activated successfully!');
            location.reload();
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('Failed to activate Free plan. Please try again.');
        });
    }

    {% if current_plan != 'premium' %}
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '12.00'
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                fetch('/plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        plan: 'premium',
                        payment_details: details
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    alert('Premium plan activated successfully!');
                    location.reload();
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Failed to activate Premium plan. Please try again.');
                });
            });
        }
    }).render('#paypal-button-container');
    {% endif %}
</script>
{% endblock %}